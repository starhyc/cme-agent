# 问题定位助手 - 产品需求文档 (PRD)

## 1. 概述

### 1.1 产品简介
问题定位助手是一个智能化的问题诊断系统，旨在将当前完全依赖人工的问题定位流程自动化和智能化，显著缩短问题定位时间，降低新员工上手难度。

### 1.2 背景
- **当前流程**: 收到报障 → 查日志 → 分析原因 → 定位根因
- **核心痛点**:
  - 涉及5个以上模块，需要反复对比多个模块日志
  - 日志分散在多个位置（本地文件、多个服务器、客户提供）
  - 部分问题需要查看代码和远程调试
  - 需要向客户解释问题并输出报告
  - 新员工对复杂业务代码不熟悉（30+模块，每个40K+行代码）

### 1.3 目标用户
- 技术支持人员
- 运维人员
- 开发人员
- 新入职员工

## 2. 问题陈述

当前问题定位完全依赖人工，效率低下：
- 日志收集耗时（需要SSH登录多台服务器）
- 多模块日志关联分析困难
- 新员工缺乏代码和业务理解
- 报告编写重复劳动

这导致问题定位周期长，新员工培养成本高，客户满意度受影响。

## 3. 成功指标

| 指标 | 当前状态 | 目标状态 |
|------|---------|---------|
| 问题定位时间 | 数小时到数天 | 1分钟内 |
| 新员工独立定位能力 | 需要数月培训 | 快速上手 |
| 报告生成 | 手动编写 | 自动生成 |
| 代码理解 | 依赖老员工 | AI辅助解释 |

## 4. 功能需求

### 4.1 核心功能（P0 - 必须实现）

#### 4.1.1 日志聚合系统
**功能描述**: 自动收集和聚合多个模块的日志

**详细需求**:
- 支持多种日志来源:
  - SSH连接服务器自动下载日志
  - 手动上传本地日志文件
  - 导入客户提供的日志
- 支持多种日志格式:
  - JSON格式
  - 纯文本格式
  - 结构化日志
- 日志解析和标准化:
  - 自动识别日志格式
  - 提取时间戳、日志级别、模块名、消息内容
  - 统一存储格式
- 日志关联:
  - 基于时间戳关联多模块日志
  - 基于请求ID/事务ID关联（如果存在）
  - 支持时间范围筛选

**验收标准**:
- [ ] 能够通过SSH连接至少5个服务器并下载日志
- [ ] 支持上传和解析JSON、文本、结构化日志
- [ ] 能够按时间线展示多模块日志
- [ ] 日志解析准确率 > 95%

#### 4.1.2 智能日志分析
**功能描述**: 使用AI分析日志，识别异常模式和关联关系

**详细需求**:
- 异常检测:
  - 识别ERROR、EXCEPTION、FATAL等错误日志
  - 检测异常堆栈信息
  - 识别性能异常（超时、慢查询等）
- 关联分析:
  - 分析跨模块的调用链路
  - 识别因果关系（A模块错误导致B模块失败）
  - 时间序列分析（问题发生前后的事件）
- 根因定位:
  - 基于日志内容推断根本原因
  - 提供可能的问题点列表（按可能性排序）
  - 关联到具体的代码模块

**验收标准**:
- [ ] 能够识别所有ERROR级别日志
- [ ] 能够提取完整的异常堆栈
- [ ] 能够生成跨模块调用链路图
- [ ] 根因定位准确率 > 80%

#### 4.1.3 代码理解系统
**功能描述**: 提供代码上下文、解释和业务流程说明

**详细需求**:
- 代码索引:
  - 索引所有30+模块的代码（Java/Spring、Python、C++、Node.js）
  - 支持按文件、类、函数搜索
  - 建立代码调用关系图
- 代码解释:
  - 针对问题相关的代码提供AI解释
  - 解释函数功能、参数含义、返回值
  - 标注关键逻辑和潜在问题点
- 业务流程说明:
  - 基于代码分析生成业务流程图
  - 展示模块间的交互关系
  - 标注数据流向
- 关键代码推荐:
  - 根据问题类型推荐需要查看的代码位置
  - 提供代码文件路径和行号
  - 高亮显示可疑代码段

**验收标准**:
- [ ] 完成所有模块代码索引（1.2M+行）
- [ ] 能够根据日志错误定位到具体代码文件和行号
- [ ] 生成的代码解释清晰易懂
- [ ] 业务流程图准确反映实际调用关系

#### 4.1.4 问题报告生成
**功能描述**: 自动生成问题分析报告和改进建议

**详细需求**:
- 报告内容:
  - 问题概述（问题类型、影响范围、发生时间）
  - 问题现象（用户反馈、日志表现）
  - 根因分析（技术原因、代码位置）
  - 解决方案建议（临时方案、根本解决方案）
  - 改进建议（代码优化、监控增强、流程改进）
- 报告格式:
  - 支持导出为PDF、Word、Markdown
  - 包含图表（日志时间线、调用链路图、流程图）
  - 支持自定义模板
- 客户友好:
  - 技术术语解释
  - 非技术人员可读的问题说明
  - 影响评估和后续行动建议

**验收标准**:
- [ ] 报告包含所有必需章节
- [ ] 支持导出为至少2种格式
- [ ] 报告生成时间 < 30秒
- [ ] 报告内容准确完整

#### 4.1.5 Web用户界面
**功能描述**: 提供直观的Web界面进行问题诊断

**详细需求**:
- 工单集成:
  - 从工单系统导入问题信息
  - 关联工单ID
- 日志上传/配置:
  - 拖拽上传日志文件
  - 配置SSH服务器连接信息
  - 选择时间范围和模块
- 分析结果展示:
  - 日志时间线视图（多模块并行展示）
  - 异常高亮显示
  - 调用链路可视化
  - 代码片段展示（带语法高亮）
  - 业务流程图展示
- 报告管理:
  - 查看历史报告
  - 编辑和导出报告
  - 分享报告链接

**验收标准**:
- [ ] 界面响应流畅（加载时间 < 2秒）
- [ ] 支持拖拽上传文件
- [ ] 日志时间线清晰易读
- [ ] 所有图表正确渲染

#### 4.1.6 权限管理
**功能描述**: 控制不同角色的访问权限

**详细需求**:
- 角色定义:
  - 管理员：所有权限
  - 普通用户：查看和分析权限，无配置权限
- 权限控制:
  - 代码访问权限（敏感代码模块限制）
  - 服务器连接权限
  - 报告导出权限
- 审计日志:
  - 记录所有操作（谁、何时、做了什么）

**验收标准**:
- [ ] 实现管理员和普通用户角色
- [ ] 权限控制生效（普通用户无法访问受限功能）
- [ ] 审计日志完整记录

### 4.2 增强功能（P1 - 应该实现）

#### 4.2.1 解决方案知识库
- 存储历史问题和解决方案
- 相似问题推荐
- 解决方案有效性反馈

#### 4.2.2 实时监控集成
- 接入监控系统告警
- 自动触发问题诊断
- 主动问题发现

### 4.3 未来考虑（P2 - 可以延后）

#### 4.3.1 远程调试支持
- 集成远程调试工具
- 断点建议
- 变量追踪

#### 4.3.2 自动修复建议
- 生成修复代码
- 自动化测试验证
- 一键部署修复

## 5. 非功能需求

### 5.1 性能要求
- 日志分析响应时间: < 1分钟
- 代码索引时间: < 10分钟（首次）
- 报告生成时间: < 30秒
- 界面加载时间: < 2秒
- 支持GB级日志文件

### 5.2 可用性要求
- 系统可用性: 99%
- 支持并发用户: 10+
- 数据备份: 每日自动备份

### 5.3 安全要求
- SSH连接加密
- 密码安全存储（加密）
- 会话超时机制
- 操作审计日志

### 5.4 兼容性要求
- 浏览器支持: Chrome、Firefox、Edge（最新版本）
- 代码语言支持: Java、Python、C++、Node.js
- 日志格式支持: JSON、文本、结构化日志

## 6. 技术架构建议

### 6.1 技术栈
**后端**:
- 主服务: Python FastAPI
- 日志处理: Python (pandas, loguru)
- AI分析: 自定义 OpenAI 兼容接口
- 代码索引: tree-sitter (多语言解析)
- 任务队列: Celery + Redis
- 数据库: PostgreSQL (元数据) + MinIO (日志文件存储)

**前端**:
- 框架: Vue 3 + TypeScript
- UI组件: Element Plus / Ant Design Vue
- 图表: ECharts
- 代码高亮: Monaco Editor

**基础设施**:
- SSH连接: paramiko (Python)
- 容器化: Docker + Docker Compose
- 反向代理: Nginx

### 6.2 核心组件

```
┌─────────────────────────────────────────────────────────┐
│                      Web Frontend                        │
│                (Vue 3 + TypeScript)                      │
└─────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────┐
│                     API Gateway                          │
│                  (FastAPI + Auth)                        │
└─────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ↓                   ↓                   ↓
┌───────────────┐  ┌────────────────┐  ┌──────────────┐
│ Log Collector │  │  AI Analyzer   │  │ Code Indexer │
│   Service     │  │    Service     │  │   Service    │
└───────────────┘  └────────────────┘  └──────────────┘
        │                   │                   │
        ↓                   ↓                   ↓
┌───────────────┐  ┌────────────────┐  ┌──────────────┐
│  MinIO/S3     │  │  Custom LLM    │  │  PostgreSQL  │
│ (Log Storage) │  │  (OpenAI API)  │  │ (Metadata)   │
└───────────────┘  └────────────────┘  └──────────────┘
```

### 6.3 数据模型

**工单表 (tickets)**:
- id, title, description, status, created_at, assigned_to

**日志文件表 (log_files)**:
- id, ticket_id, module_name, file_path, upload_time, file_size

**分析结果表 (analysis_results)**:
- id, ticket_id, root_cause, affected_modules, code_locations, created_at

**报告表 (reports)**:
- id, ticket_id, content, format, generated_at

**代码索引表 (code_index)**:
- id, module_name, file_path, function_name, line_start, line_end, language

## 7. 实施计划（2-3周）

### 第一周: 基础设施 + 日志系统

**Day 1-2: 项目搭建**
- 初始化项目结构
- 搭建开发环境（Docker Compose）
- 配置数据库和存储
- 实现基础认证系统

**Day 3-4: 日志收集模块**
- 实现SSH连接和文件下载
- 实现文件上传功能
- 日志解析器（JSON、文本、结构化）
- 日志存储和检索

**Day 5-7: 日志分析模块**
- 集成LLM API
- 实现异常检测算法
- 实现日志关联分析
- 根因定位逻辑

### 第二周: 代码理解 + 前端

**Day 8-10: 代码索引系统**
- 实现代码扫描和解析（tree-sitter）
- 建立代码索引数据库
- 实现代码搜索功能
- AI代码解释集成

**Day 11-12: 业务流程分析**
- 基于代码分析生成调用关系
- 实现流程图生成
- 关键代码推荐算法

**Day 13-14: 前端开发（第一阶段）**
- 实现登录和权限控制
- 工单管理界面
- 日志上传和配置界面
- 基础布局和导航

### 第三周: 集成 + 优化

**Day 15-16: 前端开发（第二阶段）**
- 日志时间线视图
- 分析结果展示
- 代码查看器（语法高亮）
- 流程图可视化

**Day 17-18: 报告生成**
- 报告模板设计
- 报告生成逻辑
- 导出功能（PDF、Markdown）
- 报告管理界面

**Day 19-20: 测试和优化**
- 功能测试
- 性能优化
- Bug修复
- 用户体验优化

**Day 21: 部署和文档**
- 生产环境部署
- 用户手册编写
- 系统演示准备

## 8. 风险和挑战

### 8.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 代码索引性能问题（1.2M+行） | 高 | 使用增量索引、缓存、异步处理 |
| LLM API调用成本和延迟 | 中 | 本地缓存结果、批量处理、选择合适的模型 |
| 多语言代码解析复杂度 | 中 | 使用成熟的解析库（tree-sitter） |
| SSH连接稳定性 | 中 | 实现重试机制、超时控制 |

### 8.2 时间风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 功能范围过大 | 高 | 严格按照P0功能实施，P1/P2延后 |
| 技术难点耗时 | 中 | 提前技术验证、使用AI辅助开发 |
| 测试时间不足 | 中 | 边开发边测试、自动化测试 |

### 8.3 业务风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 用户接受度 | 中 | 早期用户参与、快速迭代 |
| 准确率不达标 | 高 | 持续优化AI提示词、人工反馈循环 |

## 9. 明确不做的事情（Out of Scope）

- ❌ 与现有日志平台集成（第一版）
- ❌ 移动端应用
- ❌ 实时日志流处理
- ❌ 自动化修复和部署
- ❌ 多租户支持
- ❌ 国际化（i18n）
- ❌ 复杂的工作流引擎
- ❌ 机器学习模型训练（使用现成的LLM）

## 10. 待解决问题

1. **LLM选择**: 使用OpenAI GPT-4还是Claude？需要考虑成本、延迟、准确率
2. **代码索引策略**: 全量索引还是按需索引？如何处理代码更新？
3. **日志存储策略**: 保留多久的日志？如何清理旧数据？
4. **业务流程图生成**: 完全自动化还是需要人工标注？
5. **SSH密钥管理**: 如何安全存储和管理多个服务器的SSH密钥？

## 11. 成功标准

系统上线后，通过以下标准验证成功：

1. **功能完整性**: 所有P0功能正常工作
2. **性能达标**: 问题定位时间 < 1分钟（80%的案例）
3. **准确性**: 根因定位准确率 > 80%
4. **易用性**: 新员工经过1小时培训即可使用
5. **稳定性**: 系统可用性 > 99%

## 12. 后续迭代计划

**V1.1 (第4-6周)**:
- 解决方案知识库
- 相似问题推荐
- 用户反馈机制

**V1.2 (第7-9周)**:
- 实时监控集成
- 主动问题发现
- 性能优化

**V2.0 (第10-12周)**:
- 远程调试支持
- 自动修复建议
- 高级分析功能

---

**文档版本**: 1.0
**创建日期**: 2026-02-02
**作者**: Product Manager
**审核状态**: 待审核
